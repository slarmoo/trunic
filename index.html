<!DOCTYPE html5>
<head>
    <link rel="stylesheet" href="./main.css" />
</head>
<body>
    <header>
        <select id="sort" onchange="{createRuneViewers(document.getElementById('sort').value); localStorage.setItem('sort', document.getElementById('sort').value)}">
            <option>numerical</option>
            <option>uses</option>
            <option>dots</option>
        </select>
    </header>
    <main>
        <div id="runes">

        </div>
        <div id="paragraphs">
            
        </div>
    </main>
</body>

<script>
    const runeCount = 0x5d;
    const runeLinks = [];
    const runeTranslations = JSON.parse(localStorage.getItem("translation")) || [];
    const inputTranslations = [];
    const occurrances = [];
    const runeHasDot = [false, false, false, false, false, false, false, false,
                        false, false, false, true,  false, false, false, false, //0f
                        false, false, false, false, false, false, false, false,
                        false, false, false, false, false, false, false, true,  //1f
                        false, false, false, false, false, true,  false, false,
                        false, true,  false, false, false, false, false, true,  //2f
                        false, false, false, false, false, true,  true,  false,
                        false, true,  true,  true,  true,  false, false, false, //3f
                        false, false, false, false, true,  false, false, true,
                        false, true,  false, false, false, false, false, true,  //4f
                        false, false, false, false, false, false, false, false, 
                        false, false, false, false, false, false, 

    ];
    const ocmap = {};
    const text = document.createElement("p");
    text.classList = "paragraph";
    const trunicText = [
        0x17, " ", 0x04, 0x08, 0x16, " ", 0x01, " ", "Civilization", " ", 0x2f, " ", 0x05, 0x2a, 0x03, " ", 0x2d, 0x02, ".\n",
        0x07, " ", 0x09, 0x06, 0x03, " ", 0x01, " ", 0x2c, 0x23, ", ", 0x0b, 0x16, " ", 0x28, 0x22, 0x0c, " ", 0x15, 0x03, " ", 0x2c, 0x23, " ", 0x07, " ", 0x09, 0x06, 0x03, "\n",
        0x01, " ", 0x0e, 0x04, 0x2e, ". ", 0x07, " ", 0x13, 0x06, 0x16, " ", 0x0d, 0x14, 0x24, 0x16, " ", 0x0a, " ", 0x21, 0x14, 0x24, 0x03, 0x2e, " ", 0x2f, "\n",
        0x0a, " ", "Holy Cross", ", ", 0x0b, 0x16, " ", 0x29, 0x1e, " ", 0x2e, 0x12, 0x16, " ", 0x0a, " ", 0x30, 0x11, 0x27, "\n",
        0x10, 0x20, " ", 0x2f, 0x1d, 0x1f, 0x25, 0x1a, ". ", 0x07, " ", 0x19, 0x0c, 0x20, 0x16, " ", 0x2b, " ", 0x0a, " ", 0x0f, " ", 0x26, "\n",
        0x0b, 0x16, " ", 0x1b, 0x03, " ", 0x2d, 0x02, " ", 0x1c, 0x31, 0x00, " ", 0x0a, " ", 0x2e, 0x32, 0x2c, 0x33, " ", 0x34, 0x03, 0x18, 0x0c, ". ",
        "\p",
        0x35, " ", 0x36, " ", 0x37, 0x38, 0x39, ", ", 0x0b, " ", 0x1f, 0x3a, 0x3b, " ", 0x3c, 0x16, " ", 0x2d, 0x02, " ", 0x3d, 0x33, " ", 0x3e, 0x2e, 0x3f, 0x40, 0x16, ". ", "\n",
        0x41, 0x42, 0x06, 0x33, " ", 0x2f, " ", 0x43, 0x06, 0x1c, ", ", 0x29, 0x44, 0x16, " ", 0x45, 0x46, 0x0c, 0x33, " ", 0x2f, " ", 0x0a, " ", 0x1c, 0x37, 0x20, ", ", "\n",
        0x47, 0x2b, 0x00, 0x16, " ", 0x0b, 0x16, " ", 0x48, 0x2e, 0x03, " ", 0x49, 0x2b, " ", 0x4a, 0x4b, 0x4c, 0x4d, " ", 0x0b, 0x16, " ", 0x4e, 0x4f, ". ", "\n",
        0x01, " ", 0x50, 0x40, " ", 0x49, " ", 0x0a, 0x48, 0x53, 0x51, 0x52, 0x06, " ", 0x30, 0x11, 0x0c, ", ", 0x01, " ", 0x2e, 0x54, 0x55, " ", 0x2f, "\n",
        0x56, 0x57, 0x0c, 0x58, 0x06, ". ", 0x59, 0x5a, 0x30, 0x2e, " ", 0x25, " ", 0x36, " ", 0x0a, " ", 0x5b, 0x5c, 0x06, 0x16, " ", 0x30, 0x5d, 0x33, ", ", "\n",
        "The Power To Defy Death. ", 
        "\p",
    ];

    for (let i = 0; i < trunicText.length; i++) {
        ocmap[trunicText[i]] = ocmap[trunicText[i]] || 0;
        ocmap[trunicText[i]]++;
    }
    
    for(let i = 0x0; i <= runeCount; i++) {
        runeLinks.push("./trunes/runes/" + decimalToHex(i) + ".png");
    }

    createRuneViewers(localStorage.getItem("sort"));
    document.getElementById('sort').value = localStorage.getItem("sort");

    function createRuneViewers(sort) {
        const runeHolder = document.getElementById("runes");
        runeHolder.innerHTML = "";

        function createRuneViewer(rune) {
            //image
            const img = document.createElement("img");
            img.width = 100;
            img.src = runeLinks[rune];
            img.classList = "image";
            img.title = decimalToHex(rune);

            img.addEventListener("mouseover", (event) => {
                const img = event.target;
                updateParagraph(img.title);
            });
            //border
            const runeBorder = document.createElement("div");
            runeBorder.classList = "holder";
            //syllable input
            const input = document.createElement("input");
            input.type = "text";
            input.classList = "inputTest";
            input.id = rune;
            inputTranslations[rune] = input;
            input.value = runeTranslations[rune] || "";

            input.addEventListener("input", (event) => {
                const input = event.target;
                runeTranslations[input.id] = input.value;
                localStorage.setItem("translation", JSON.stringify(runeTranslations));
                updateParagraph();
            });
            //info
            const info = document.createElement("div");
            info.classList = "info";
            //occurance
            const occurrance = document.createElement("span");
            occurrances[rune] = occurrance;
            //append children
            runeBorder.appendChild(img);
            runeHolder.appendChild(runeBorder);
            info.append(occurrance);
            info.appendChild(input);
            runeBorder.appendChild(info);
        }
        if(sort == "numerical") {
            for(const rune in runeLinks) {
                createRuneViewer(rune);
            }
        } else if(sort == "uses") {
            let imgs = [];
            for (const val in ocmap) {
                const int = parseInt(val);
                if(!Number.isNaN(int)) {
                    imgs.push(int);
                }
            }
            imgs.sort((a, b) => ocmap[b] - ocmap[a]);
            for(const val in imgs) {
                createRuneViewer(imgs[val]);
            }
        } else if(sort="dots") {
            let imgs = runeLinks.slice();
            imgs.forEach((value, index) => imgs[index] = index);
            imgs.sort((a, b) => +runeHasDot[b] - +runeHasDot[a]);
            console.log(imgs);
            for(const val in imgs) {
                createRuneViewer(imgs[val]);
            }
        }
        for (let i = 0; i < occurrances.length; i++) {
            occurrances[i].innerText = ocmap[i] + " times,\n" + (Math.round(ocmap[i] / trunicText.length * 10000) / 100) + "%";
        }
    }

    updateParagraph();

    function updateParagraph(highlight = -1) {
        text.innerHTML = "";

        for(let i = 0; i < trunicText.length; i++) {
            if(typeof trunicText[i] == "number" ) {
                if(!runeTranslations[trunicText[i]]) {
                    const img = document.createElement("img");
                    img.width = 20;
                    img.src = runeLinks[trunicText[i]];
                    img.classList = "image";
                    if(highlight == trunicText[i]) {
                        img.style.filter = "brightness(1.50)";
                        img.style.border = "2px solid black";
                    }
                    const span = document.createElement("span");
                    span.appendChild(img);
                    // text.innerHTML += span;
                    text.appendChild(span);
                    span.classList = "span";
                } else {
                    text.innerHTML += runeTranslations[trunicText[i]];
                }
            } else {
                if(trunicText[i].includes("\n")) {
                    text.appendChild(document.createElement("br"));
                } else if (trunicText[i].includes("\p")) {
                    for(let j = 0; j < 3; j++) {
                        text.appendChild(document.createElement("br"));
                    }
                } else {
                    text.innerHTML += trunicText[i];
                    if (trunicText[i] + "".includes(" ")) {
                        const span = document.createElement("span");
                        span.style.padding = "3px";
                        text.appendChild(span);
                    }
                }
            }
        }
    }

    document.getElementById("paragraphs").appendChild(text);

    function decimalToHex(decimal) {
        const original = decimal;
        let hex = "";
        const hexVals = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f"];
        while (decimal > 0) {
            hex = hexVals[decimal % 16] + hex;
            decimal = Math.floor(decimal /16);
        }
        return "0x" + (hex.length < 2 ? "0" : "") + (hex.length < 1 ? "0" : "") + hex;
    }
</script>